# 游戏基础设定

## 评级方式

按照演奏的累计准确率进行评级，评级依据如下：

|评价|准确率|
|----|----|
|SSS |99.8%|
|SS|99%|
|S|97%|
|A|94%|
|B|90%|
|C|85%|
|D|60%|
|Failed|60%以下|

累计准确率的计算方式如下：

设*n*为已击打的Note总数，$ a_i $为第i个Note的击打准确率，则：

$$
accuracy=\frac{\sum_{i=1}^n a_i}{n}
$$

## 单个Note准确率

|击打评价|准确率|
|----|----|
|Perfect|100%|
|Great|80%|
|Good|50%|
|Bad|20%|
|Miss|0%|

### 计算示例

设*g*为Great数，*m*为Miss数，*n*为物量，*a*为精确度，则：

$$
\frac{m}{n}×0+\frac{g}{n}×0.8+\frac{n-g-m}{n}×1=a
$$

化简得

$$
g=5[(1-a)n-m]\\
m=-0.2g+(1-a)n
$$

#### 谱面物量1000Notes

##### 达到SSS评级的Great数量（FC）

$$
g=5(0.002*1000)=10
$$

990-10-0-0-0

##### 达到SS评级的Great数量（FC）

$$
g=5(0.01*1000)=50
$$

950-50-0-0-0

##### 达到SS评级的Great数量（5Miss）

$$
g=5(0.01*1000-5)=25
$$

970-25-0-0-5

##### 达到S评级的Great数量（FC）

$$
g=5(0.03*1000)=150
$$

850-150-0-0-0

##### 达到S评级的Great数量（10Miss）

$$
g=5(0.03*1000-10)=100
$$

890-100-0-0-10

#### 谱面物量500Notes

##### 达到S评级的Great数量（FC）

$$
g=5(0.03*500)=75
$$

425-75-0-0-0

##### 达到S评级的Great数量（5Miss）

$$
g=5(0.03*500-5)=50
$$

445-50-0-0-5

##### 达到A评级的Great数量（10Miss）

$$
g=5(0.06*500-10)=50
$$

390-100-0-0-10

##### 达到B评级的Great数量（20Miss）

$$
g=5(0.1*500-20)=150
$$

330-150-0-0-20

##### 达到C评级的Great数量（30Miss）

$$
g=5(0.15*500-30)=225
$$

245-225-0-0-30

##### Failed的Miss数量（30%Great）

$$
m>-0.2*\frac{3(500-m)}{10}+0.15*500\\
m>47\frac{41}{47}\approx48
$$

## 得分

### 计算方法

可视得分是**实际得分转换为百万分制的整数**。

实际得分分为两部分：

- 判定得分

  即Note的准确率，设为$ a_i $。
  
- 连击得分

  设*p*、*q*为累计倍率：
  
  - 每100连击，*p*增加0.5%，且若连击归零，*p*变为0；
  
  - 每连续得到50个Perfect评价，*q*增加0.5%，且若得到Great及以下的判定，*q*变为0。
  
设每个Note的得分为$ x_i $，则：
$$
x_i=a_i(p+q)
$$

计算分为两部分：

- 实际总分（*f*）：假定所有的Note判定均为Perfect时，累加的结果。

- 实际得分（*s*）：玩家游玩时Note得分累加的结果。

则得分为：

$$
\frac{s}{f}*1000000
$$


### 测试计算

谱面物量为501Notes

设基础分数为*x*，则有

51-100Combo得分：

$$
(1+0.005)x
$$

101-150Combo得分：

$$
(1+0.015)x
$$

……

450-500Combo得分：

$$
(1+0.065)x
$$

500Combo后得分：

$$
(1+0.075)x
$$

总分：

$$
50x+50(1+0.005)x+50(1+0.015)x+...+50(1+0.065)x+(1+0.075)x\\ =1,000,000\\
\Rightarrow x \approx 1933.02
$$

算法如下

```javascript
function test (maxCombo) {
    let part = Math.floor(maxCombo / 50);
    let leftCombo = maxCombo - part * 50;
    let lastAddition = 0;
    let addition = 0;
    for (let i = 0; i <= part; i++) {
        let grAddition = Math.floor(i / 2) * 0.005;
        let pAddition = i * 0.005;
        let totalAddition = 1 + grAddition + pAddition;
        if (i === part) {
            lastAddition = totalAddition;
            break;
        }
        console.log(`from \${50*i+1} to \${50*(i+1)} addition ${totalAddition}`);
        addition += totalAddition;
    }
    console.log(addition, lastAddition);
    let score = 1e6 / (50 * addition + lastAddition * leftCombo);
    return score;
}
```

## 判定

按键的判定范围为Note所在轨道的左、右各0.75个轨道之间（共计2.5个轨道的宽度）。
下表为各种按键的判定范围（单位：毫秒）以及Miss判定的情况：

| Note种类                  | Perfect | Great      | Good        | Bad         | Miss                                 |
| ------------------------- | ------- | --------- | ------------ | ------------ | ------------------------------------ |
| 单键                      | -40 ~ +40 | -90 ~ +90 | -111 ~ +111 | -133 ~ +133 | 无输入 |
| 滑键                      | -40 ~ +40 | -90 ~ +90 | -111 ~ +111 | -133 ~ +133 | 无输入或按下未滑动 |
| 直长条头                  | -40 ~ +40 | -90 ~ +90 | -111 ~ +111 | -133 ~ +133 | 无输入或滑动 |
| 直长条尾                  | -40 ~ +40 | -90 ~ +90 | -111 ~ +111 | -133 ~ +133 | 无输入或滑动 |
| 直长条尾滑键              | -57 ~ +57 | -107 ~ +107 | -128 ~ +128 | -150 ~ +150 | 无输入或在击打长条时直接松开滑条 |
| 斜长条头                  | -57 ~ +57 | -107 ~ +107 | -128 ~ +128 | -150 ~ +150 | 无输入或滑动 |
| 斜长条尾                  | -34 ~ +200 | -84 ~ -50 | -100 ~ -84 | -117 ~ -100 | 无输入或滑动 |
| 斜长条尾滑键              | 0 ~ +100  | 无      | 无      | 无      | 无输入或在击打长条时直接松开滑条 |
| 滑条节点                  | 0 ~ +200 | 无      | 无      | 无      | 无输入 |

另外，值得注意的判定机制有：

> * 当一次输入处于多个Note的判定范围内时，**离判定线最近的Note将优先判定**。

<vssue title="Vssue Demo" />
